<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pedidos | Tu Panadería</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <!-- Scripts de Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #FDFBF8; }
        .card { background-color: white; border-radius: 0.75rem; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); padding: 1rem; position: relative; overflow: hidden; }
        .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: all 0.2s ease-in-out; cursor: pointer; text-align: center; }
        .btn-primary { background-color: #6D4C41; color: white; }
        .btn-primary:hover { background-color: #4E342E; }
        input[type="number"] { border-radius: 0.5rem; border: 1px solid #D1C4E9; padding: 0.5rem; width: 60px; text-align: center; }
        input[type="number"]:focus { outline: none; border-color: #6D4C41; box-shadow: 0 0 0 2px #D1C4E9; }

        .modal-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 1rem;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-container.hidden { display: none; }
        .modal-content {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            padding: 1.5rem;
            position: relative;
            z-index: 50;
            width: 90%;
            max-width: 700px;
            margin: auto;
        }

        .product-card-carousel {
            position: relative;
            width: 100%;
            aspect-ratio: 3 / 4;
            overflow: hidden;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            margin-bottom: 0.75rem;
            cursor: pointer;
        }
        .product-card-carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
            height: 100%;
        }
        .product-card-carousel-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #f0f0f0;
        }
        .product-card-carousel-slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .carousel-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 0.3rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 25px;
            height: 25px;
            font-size: 0.8rem;
        }
        .carousel-nav-btn.left { left: 0.5rem; }
        .carousel-nav-btn.right { right: 0.5rem; }

        .publication-carousel-container {
            position: relative;
            width: 100%;
            height: 400px;
            overflow: hidden;
            border-radius: 0.75rem;
            background-color: #f0f0f0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .publication-carousel-track {
            display: flex;
            transition: transform 0.3s ease-in-out;
            height: 100%;
        }
        .publication-carousel-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .publication-carousel-slide img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }
        .publication-modal-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            padding: 0.5rem;
            cursor: pointer;
            z-index: 10;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .publication-modal-arrow.left { left: 0.5rem; }
        .publication-modal-arrow.right { right: 0.5rem; }
        .close-modal-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background-color: rgba(0,0,0,0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            cursor: pointer;
            z-index: 60;
        }
    </style>
</head>
<body>
    <div class="container mx-auto p-4 md:p-8">
        <h1 class="text-3xl font-bold text-stone-700 mb-6 text-center">Nuestros Productos</h1>
        
        <div id="products-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
            <p class="text-center text-stone-500 col-span-full">Cargando productos...</p>
        </div>

        <div class="fixed bottom-4 right-4">
            <button id="view-cart-btn" class="btn btn-primary flex items-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"/></svg>
                Ver Carrito (<span id="cart-item-count">0</span>)
            </button>
        </div>
    </div>

    <div id="cart-modal" class="modal-container hidden">
        <div class="modal-content max-w-lg">
            <h2 class="text-2xl font-bold text-stone-700 mb-4">Tu Pedido</h2>
            <div id="cart-items" class="space-y-4 max-h-96 overflow-y-auto pr-2">
                <p class="text-stone-500">El carrito está vacío.</p>
            </div>
            <div class="mt-6 pt-4 border-t border-stone-200">
                <div class="flex justify-between items-center text-xl font-bold text-stone-800 mb-4">
                    <span>Total:</span>
                    <span id="cart-total">$0.00</span>
                </div>
                <div class="space-y-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-stone-600 mb-1">Tu Nombre</label>
                        <input type="text" id="customer-name" placeholder="Ej: Juan Pérez" required class="w-full">
                    </div>
                    <div>
                        <label for="customer-phone" class="block text-sm font-medium text-stone-600 mb-1">Tu Teléfono (opcional)</label>
                        <input type="tel" id="customer-phone" placeholder="Ej: 1123456789" class="w-full">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-stone-600 mb-1">Corte del Pan</label>
                        <div class="flex flex-wrap gap-x-4 gap-y-2">
                            <label class="flex items-center text-sm"><input type="radio" name="slicing" value="Sin cortar" class="mr-1" checked>Sin cortar</label>
                            <label class="flex items-center text-sm"><input type="radio" name="slicing" value="Cortado" class="mr-1">Cortado</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-4 mt-6">
                    <button id="close-cart-modal" class="btn bg-stone-200 text-stone-700">Cerrar</button>
                    <button id="submit-order-btn" class="btn btn-primary">Confirmar Pedido</button>
                </div>
            </div>
        </div>
    </div>

    <div id="publication-modal" class="modal-container hidden">
        <div class="modal-content max-w-3xl !p-0">
            <button class="close-modal-btn" id="close-publication-modal">&times;</button>
            <div class="grid grid-cols-1 md:grid-cols-2 h-full">
                <div class="publication-carousel-container flex-shrink-0 md:h-auto h-80">
                    <div id="publication-carousel-track" class="publication-carousel-track"></div>
                    <button type="button" class="publication-modal-arrow left" id="publication-carousel-prev">&#10094;</button>
                    <button type="button" class="publication-modal-arrow right" id="publication-carousel-next">&#10095;</button>
                </div>
                <div class="p-4 md:p-6 flex flex-col justify-between">
                    <div>
                        <h3 id="publication-recipe-name" class="text-2xl font-bold text-stone-700 mb-2"></h3>
                        <p id="publication-recipe-description" class="text-stone-600 text-sm mb-4 whitespace-pre-wrap"></p>
                        <p id="publication-recipe-price" class="text-xl font-bold text-stone-800 mb-4"></p>
                    </div>
                    <div class="flex items-center justify-between gap-4 mt-auto pt-4 border-t border-stone-200">
                        <input type="number" id="publication-quantity-input" value="1" min="1" class="flex-grow">
                        <button id="publication-add-to-cart-btn" class="btn btn-primary flex-shrink-0">Agregar</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const firebaseConfig = {
                apiKey: "AIzaSyBY-BS1UfJjTcaQWBkqLfcIT6sCngfaCmU",
                authDomain: "mi-panaderia-online.firebaseapp.com",
                projectId: "mi-panaderia-online",
                storageBucket: "mi-panaderia-online.appspot.com",
                messagingSenderId: "880103240107",
                appId: "1:880103240107:web:7aef22bea8abdeae7fa2ee"
            };
            try { firebase.initializeApp(firebaseConfig); } catch (e) { console.error("Firebase ya fue inicializado."); }
            
            const db = firebase.firestore();
            const recipesCollection = db.collection('recipes');
            const ordersCollection = db.collection('orders');

            const productsContainer = document.getElementById('products-container');
            const cartModal = document.getElementById('cart-modal');
            const viewCartBtn = document.getElementById('view-cart-btn');
            const closeCartModalBtn = document.getElementById('close-cart-modal');
            const cartItemsContainer = document.getElementById('cart-items');
            const cartTotalEl = document.getElementById('cart-total');
            const cartItemCountEl = document.getElementById('cart-item-count');
            const submitOrderBtn = document.getElementById('submit-order-btn');
            
            const publicationModal = document.getElementById('publication-modal');
            const closePublicationModalBtn = document.getElementById('close-publication-modal');
            const publicationCarouselTrack = document.getElementById('publication-carousel-track');
            const publicationCarouselPrevBtn = document.getElementById('publication-carousel-prev');
            const publicationCarouselNextBtn = document.getElementById('publication-carousel-next');
            const publicationRecipeNameEl = document.getElementById('publication-recipe-name');
            const publicationRecipeDescriptionEl = document.getElementById('publication-recipe-description');
            const publicationRecipePriceEl = document.getElementById('publication-recipe-price');
            const publicationQuantityInput = document.getElementById('publication-quantity-input');
            const publicationAddToCartBtn = document.getElementById('publication-add-to-cart-btn');

            let cart = JSON.parse(localStorage.getItem('bakeryCart')) || [];
            let recipes = [];

            const formatCurrency = (amount) => new Intl.NumberFormat('es-AR', { style: 'currency', currency: 'ARS' }).format(amount || 0);

            function renderProducts() {
                productsContainer.innerHTML = '<p class="text-center text-stone-500 col-span-full">Cargando productos...</p>';
                recipesCollection.orderBy('name').onSnapshot(snapshot => {
                    recipes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    productsContainer.innerHTML = '';
                    if (recipes.length === 0) {
                        productsContainer.innerHTML = '<p class="text-center text-stone-500 col-span-full">No hay productos disponibles.</p>';
                        return;
                    }

                    recipes.forEach(recipe => {
                        const productCard = document.createElement('div');
                        productCard.className = 'card pb-4';
                        productCard.dataset.recipeId = recipe.id;

                        const imageUrls = recipe.imageUrls || [];
                        const firstImage = imageUrls[0] || 'https://via.placeholder.com/300x400?text=Sin+Imagen';

                        let carouselHtml = `
                            <div class="product-card-carousel" data-recipe-id="${recipe.id}">
                                <div class="product-card-carousel-track">
                                    ${(imageUrls.length > 0 ? imageUrls : [firstImage]).map(url => `<div class="product-card-carousel-slide"><img src="${url}" alt="${recipe.name}"></div>`).join('')}
                                </div>
                                ${imageUrls.length > 1 ? `
                                    <button type="button" class="carousel-nav-btn left" data-direction="-1">&#10094;</button>
                                    <button type="button" class="carousel-nav-btn right" data-direction="1">&#10095;</button>
                                ` : ''}
                            </div>
                        `;

                        productCard.innerHTML = `
                            ${carouselHtml}
                            <div class="px-4">
                                <h3 class="font-bold text-lg text-stone-800 mb-1">${recipe.name}</h3>
                                <p class="text-stone-700 text-xl font-semibold mb-3">${formatCurrency(recipe.salePrice || 0)}</p>
                                <div class="flex items-center justify-between gap-2">
                                    <input type="number" value="1" min="1" class="add-to-cart-quantity w-20">
                                    <button class="btn btn-primary add-to-cart-btn" data-recipe-id="${recipe.id}">Agregar</button>
                                </div>
                            </div>
                        `;
                        productsContainer.appendChild(productCard);
                    });

                    productsContainer.querySelectorAll('.product-card-carousel').forEach(initCardCarousel);
                });
            }

            function initCardCarousel(carouselEl) {
                const track = carouselEl.querySelector('.product-card-carousel-track');
                const slides = Array.from(carouselEl.querySelectorAll('.product-card-carousel-slide'));
                const prevBtn = carouselEl.querySelector('.carousel-nav-btn.left');
                const nextBtn = carouselEl.querySelector('.carousel-nav-btn.right');
                
                let currentSlide = 0;
                if (slides.length <= 1) return;

                function updateCarousel() {
                    track.style.transform = `translateX(-${currentSlide * 100}%)`;
                }

                prevBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentSlide = (currentSlide - 1 + slides.length) % slides.length;
                    updateCarousel();
                });

                nextBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    currentSlide = (currentSlide + 1) % slides.length;
                    updateCarousel();
                });
                
                carouselEl.addEventListener('click', (e) => {
                    const recipeId = carouselEl.dataset.recipeId;
                    const recipe = recipes.find(r => r.id === recipeId);
                    if (recipe) openPublicationModal(recipe);
                });
            }


            function updateCartCount() {
                cartItemCountEl.textContent = cart.reduce((sum, item) => sum + item.quantity, 0);
            }

            function renderCartItems() {
                cartItemsContainer.innerHTML = '';
                let total = 0;

                if (cart.length === 0) {
                    cartItemsContainer.innerHTML = '<p class="text-stone-500">El carrito está vacío.</p>';
                    cartTotalEl.textContent = formatCurrency(0);
                    return;
                }

                cart.forEach(item => {
                    const recipe = recipes.find(r => r.id === item.recipeId);
                    if (!recipe) return;

                    const itemTotal = recipe.salePrice * item.quantity;
                    total += itemTotal;

                    const cartItemEl = document.createElement('div');
                    cartItemEl.className = 'flex items-center justify-between bg-stone-50 p-3 rounded-md';
                    cartItemEl.innerHTML = `
                        <div class="flex items-center gap-2">
                            <input type="number" value="${item.quantity}" min="1" class="cart-item-quantity w-16" data-recipe-id="${recipe.id}">
                            <span>${recipe.name}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span>${formatCurrency(itemTotal)}</span>
                            <button class="text-red-500 hover:text-red-700 font-bold ml-2 remove-from-cart-btn" data-recipe-id="${recipe.id}">&times;</button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemEl);
                });

                cartTotalEl.textContent = formatCurrency(total);
            }

            function addToCart(recipeId, quantity) {
                const existingItemIndex = cart.findIndex(item => item.recipeId === recipeId);
                if (existingItemIndex > -1) {
                    cart[existingItemIndex].quantity += quantity;
                } else {
                    cart.push({ recipeId, quantity });
                }
                localStorage.setItem('bakeryCart', JSON.stringify(cart));
                updateCartCount();
                renderCartItems();
            }

            function updateCartItemQuantity(recipeId, newQuantity) {
                const item = cart.find(item => item.recipeId === recipeId);
                if (item) {
                    item.quantity = newQuantity;
                    if (item.quantity <= 0) {
                        removeFromCart(recipeId);
                    } else {
                        localStorage.setItem('bakeryCart', JSON.stringify(cart));
                        updateCartCount();
                        renderCartItems();
                    }
                }
            }

            function removeFromCart(recipeId) {
                cart = cart.filter(item => item.recipeId !== recipeId);
                localStorage.setItem('bakeryCart', JSON.stringify(cart));
                updateCartCount();
                renderCartItems();
            }

            productsContainer.addEventListener('click', (e) => {
                const addToCartBtn = e.target.closest('.add-to-cart-btn');
                if (addToCartBtn) {
                    const recipeId = addToCartBtn.dataset.recipeId;
                    const quantityInput = addToCartBtn.previousElementSibling;
                    const quantity = parseInt(quantityInput.value);
                    if (quantity > 0) {
                        addToCart(recipeId, quantity);
                        alert(`${quantity} producto(s) agregado(s) al carrito.`);
                    }
                }
            });

            viewCartBtn.addEventListener('click', () => {
                renderCartItems();
                cartModal.classList.remove('hidden');
            });

            closeCartModalBtn.addEventListener('click', () => {
                cartModal.classList.add('hidden');
            });
            cartModal.addEventListener('click', (e) => {
                if (e.target === cartModal) cartModal.classList.add('hidden');
            });

            cartItemsContainer.addEventListener('change', (e) => {
                if (e.target.classList.contains('cart-item-quantity')) {
                    const recipeId = e.target.dataset.recipeId;
                    const newQuantity = parseInt(e.target.value);
                    updateCartItemQuantity(recipeId, newQuantity);
                }
            });

            cartItemsContainer.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-from-cart-btn')) {
                    const recipeId = e.target.dataset.recipeId;
                    removeFromCart(recipeId);
                }
            });

            submitOrderBtn.addEventListener('click', async () => {
                if (cart.length === 0) {
                    alert('Tu carrito está vacío.');
                    return;
                }

                const customerName = document.getElementById('customer-name').value;
                const customerPhone = document.getElementById('customer-phone').value;
                const slicingOption = document.querySelector('input[name="slicing"]:checked').value;

                if (!customerName) {
                    alert('Por favor, ingresa tu nombre.');
                    return;
                }

                const orderItems = cart.map(item => ({
                    recipeId: item.recipeId,
                    quantity: item.quantity
                }));

                try {
                    await ordersCollection.add({
                        customerName,
                        customerPhone,
                        deliveryDate: "",
                        slicingOption,
                        deliveryTimeSlot: "Cualquier horario",
                        items: orderItems,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert('¡Pedido realizado con éxito! Nos pondremos en contacto pronto.');
                    cart = [];
                    localStorage.removeItem('bakeryCart');
                    updateCartCount();
                    cartModal.classList.add('hidden');
                } catch (error) {
                    console.error('Error al enviar el pedido:', error);
                    alert('Hubo un error al procesar tu pedido. Inténtalo de nuevo.');
                }
            });

            // --- Publication Modal Logic ---
            let currentPublicationRecipe = null;
            let currentPublicationSlide = 0;

            function openPublicationModal(recipe) {
                currentPublicationRecipe = recipe;
                publicationRecipeNameEl.textContent = recipe.name;
                publicationRecipeDescriptionEl.textContent = recipe.description || 'Sin descripción.';
                publicationRecipePriceEl.textContent = formatCurrency(recipe.salePrice || 0);
                publicationQuantityInput.value = 1;

                renderPublicationCarousel(recipe.imageUrls || []);
                publicationModal.classList.remove('hidden');
            }

            function renderPublicationCarousel(imageUrls) {
                publicationCarouselTrack.innerHTML = '';
                const imagesToDisplay = imageUrls.length > 0 ? imageUrls : ['https://via.placeholder.com/400x300?text=Sin+Imagen'];

                imagesToDisplay.forEach((url, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'publication-carousel-slide';
                    slide.innerHTML = `<img src="${url}" alt="Imagen de ${currentPublicationRecipe.name} ${index + 1}">`;
                    publicationCarouselTrack.appendChild(slide);
                });
                
                publicationCarouselPrevBtn.style.display = imagesToDisplay.length > 1 ? 'flex' : 'none';
                publicationCarouselNextBtn.style.display = imagesToDisplay.length > 1 ? 'flex' : 'none';
                
                currentPublicationSlide = 0;
                updatePublicationCarouselPosition();
            }

            function updatePublicationCarouselPosition() {
                const totalSlides = publicationCarouselTrack.children.length;
                if (totalSlides === 0) return;
                const offset = -currentPublicationSlide * 100;
                publicationCarouselTrack.style.transform = `translateX(${offset}%)`;
            }
            
            publicationCarouselPrevBtn.addEventListener('click', () => {
                const totalSlides = publicationCarouselTrack.children.length;
                if (totalSlides <= 1) return;
                currentPublicationSlide = (currentPublicationSlide - 1 + totalSlides) % totalSlides;
                updatePublicationCarouselPosition();
            });

            publicationCarouselNextBtn.addEventListener('click', () => {
                const totalSlides = publicationCarouselTrack.children.length;
                if (totalSlides <= 1) return;
                currentPublicationSlide = (currentPublicationSlide + 1) % totalSlides;
                updatePublicationCarouselPosition();
            });

            publicationAddToCartBtn.addEventListener('click', () => {
                if (currentPublicationRecipe) {
                    const quantity = parseInt(publicationQuantityInput.value);
                    if (quantity > 0) {
                        addToCart(currentPublicationRecipe.id, quantity);
                        alert(`${quantity} producto(s) de ${currentPublicationRecipe.name} agregado(s) al carrito.`);
                        publicationModal.classList.add('hidden');
                    }
                }
            });

            closePublicationModalBtn.addEventListener('click', () => publicationModal.classList.add('hidden'));
            publicationModal.addEventListener('click', (e) => {
                if (e.target === publicationModal) publicationModal.classList.add('hidden');
            });

            updateCartCount();
            renderProducts();
        });
    </script>
</body>
</html>

